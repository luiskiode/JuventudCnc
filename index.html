<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Juventud CNC</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <meta name="theme-color" content="#0b1020" />

  <!-- SDKs base -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-messaging-compat.js"></script>

  <!-- ConfiguraciÃ³n de Supabase y Firebase
       (IMPORTANTE: asegurarse que estos archivos definan:
        - window.supabaseClient = supabase.createClient(...)
        - firebase.initializeApp(...)
       ) -->
  <script src="supabase-config.js" defer></script>
  <script src="firebase-config.js" defer></script>

  <!-- Modo diseÃ±o (lee jc_tokens) -->
  <script src="design-mode.js" defer></script>

  <!-- Panel tÃ©cnico / diagnÃ³stico -->
  <script src="debug-dashboard.js" defer></script>
</head>

<body class="app-shell">
  <!-- Drawer lateral -->
  <aside id="drawer" class="drawer" aria-label="MenÃº principal">
    <div class="drawer-header">
      <h2>Juventud CNC</h2>
      <button id="closeDrawer" class="icon-btn" aria-label="Cerrar menÃº">âœ•</button>
    </div>
    <nav class="drawer-nav">
      <a href="#inicio" data-tab="inicio">Inicio</a>
      <a href="#eventos" data-tab="eventos">Eventos</a>
      <a href="#comunidad" data-tab="comunidad">Comunidad</a>
      <a href="#perfil" data-tab="perfil">Mi perfil</a>
      <a href="#recursos" data-tab="recursos">Recursos</a>
      <a href="#avisos" data-tab="avisos">Avisos</a>
    </nav>
    <footer class="drawer-footer">
      v1.0 â€¢ Pensado para jÃ³venes ğŸ’™ğŸ’—
    </footer>
  </aside>

  <!-- Overlay compartido (drawer + Angie) -->
  <div id="overlay" class="overlay" tabindex="-1" aria-hidden="true"></div>

  <!-- Topbar -->
  <header class="topbar">
    <button id="openDrawer" class="icon-btn" aria-label="MenÃº">â˜°</button>
    <h1 class="topbar-title">Juventud CNC</h1>
    <div class="topbar-actions">
      <select id="themePicker" class="theme-picker" aria-label="Tema visual">
        <option value="auto">Auto</option>
        <option value="chicos">Chicos ğŸ’™</option>
        <option value="chicas">Chicas ğŸ’—</option>
        <option value="mix">Mix ğŸ’™ğŸ’—</option>
      </select>
      <button id="btnAngie" class="icon-btn" aria-label="Herramienta de colores">ğŸ¨</button>
      <button id="btnPerfil" class="icon-btn" aria-label="Perfil">ğŸ‘¤</button>
    </div>
  </header>

  <!-- Vistas -->
  <main class="container" id="main">
    <!-- INICIO -->
    <section class="view active" id="view-inicio" data-view="inicio" tabindex="-1">
      <!-- Mensaje semanal -->
      <section class="card" id="mensaje-semanal">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ•Šï¸">Mensaje semanal</h2>
          <span class="badge badge-mix">Para chicos ğŸ’™ y chicas ğŸ’—</span>
        </header>
        <article class="card-body">
          <h3 id="msgTitle">Cargando mensaje...</h3>
          <p id="msgBody">
            AquÃ­ aparecerÃ¡ una palabra breve para acompaÃ±ar tu semana:
            estudio, trabajo, servicio y descanso.
          </p>
          <small id="msgMeta">â€“</small>
        </article>
      </section>

      <!-- Hero bienvenida -->
      <section class="card hero">
        <div class="hero-content">
          <h2>Bienvenido a Juventud CNC</h2>
          <p>Un solo espacio para que jÃ³venes hombres y mujeres crezcan, sirvan y se encuentren con Dios.</p>
          <div class="hero-badges" aria-hidden="true">
            <span class="badge badge-guy">Chicos ğŸ’™</span>
            <span class="badge badge-girl">Chicas ğŸ’—</span>
          </div>
        </div>
        <div class="hero-icons" aria-hidden="true">
          âœï¸
          <span class="hero-gradient-bubbles"></span>
        </div>
      </section>

      <!-- PrÃ³ximos eventos (vista rÃ¡pida) -->
      <section class="card">
        <div class="card-header">
          <h3 class="with-emoji" data-emoji="ğŸ“…">PrÃ³ximos eventos</h3>
          <a class="link" href="#eventos" data-tab="eventos">Ver todos</a>
        </div>
        <ul id="eventListHome" class="event-list"></ul>
        <p class="muted small">
          AquÃ­ verÃ¡s los prÃ³ximos 4 eventos. Para ver el calendario completo entra en la pestaÃ±a
          <strong>Eventos</strong>.
        </p>
      </section>
    </section>

    <!-- EVENTOS -->
    <section class="view" id="view-eventos" data-view="eventos" tabindex="-1">
      <section class="card">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ“…">Eventos</h2>
          <div class="filter-group">
            <label for="filtroTipo" class="muted small">Filtrar</label>
            <select id="filtroTipo">
              <option value="">Todos</option>
              <option value="reuniÃ³n">ReuniÃ³n</option>
              <option value="formaciÃ³n">FormaciÃ³n</option>
              <option value="retiro">Retiro</option>
              <option value="vigilia">Vigilia</option>
              <option value="voluntariado">Voluntariado</option>
            </select>
          </div>
        </header>
        <ul id="eventList" class="event-list"></ul>
      </section>
    </section>

    <!-- COMUNIDAD -->
    <section class="view" id="view-comunidad" data-view="comunidad" tabindex="-1">
      <!-- Registro -->
      <section class="card" id="miembros">
        <h2 class="with-emoji" data-emoji="ğŸ‘¥">Registro de miembros</h2>
        <form id="formMiembro" class="grid">
          <input name="nombre" placeholder="Nombre y apellido" required />
          <input name="edad" type="number" placeholder="Edad" min="10" max="99" required />
          <input name="contacto" type="tel" placeholder="Contacto (celular)" />
          <input name="ministerio" placeholder="Ministerio / grupo (opcional)" />
          <select name="rol_key">
            <option value="miembro">Miembro</option>
            <option value="moderador">Moderador</option>
          </select>
          <button class="btn" type="submit">Guardar</button>
        </form>
      </section>

      <!-- Comunidad activa (chips) -->
      <section class="card">
        <h3 class="with-emoji" data-emoji="â­">Comunidad activa</h3>
        <div class="grid grid-compact">
          <button class="chip chip-guy" data-action="retos">ğŸ’ª Retos para chicos</button>
          <button class="chip chip-girl" data-action="retos-chicas">âœ¨ Retos para chicas</button>
          <button class="chip" data-action="noticias">ğŸ“° Noticias parroquiales</button>
          <button class="chip" data-action="multimedia">ğŸ¶ Multimedia</button>
          <button class="chip" data-action="foro">ğŸ’¬ Foro joven</button>
        </div>
        <p class="muted small">(Estas secciones se irÃ¡n habilitando por fases.)</p>
      </section>
    </section>

    <!-- PERFIL -->
    <section class="view" id="view-perfil" data-view="perfil" tabindex="-1">
      <section class="card perfil-card">
        <div class="perfil-header">
          <div class="perfil-avatar-wrapper">
            <div class="perfil-avatar" id="perfilAvatar">
              <span id="perfilAvatarInicial">ğŸ™‚</span>
              <img id="perfilAvatarImg" alt="Foto de perfil" />
            </div>
            <button type="button" class="btn small perfil-foto-btn" id="btnCambiarFoto">
              Cambiar foto
            </button>
            <input type="file" id="perfilFotoInput" accept="image/*" hidden />
          </div>
          <div class="perfil-header-text">
            <h3 class="with-emoji" data-emoji="ğŸ™‹â€â™‚ï¸">Mi perfil</h3>
            <p class="perfil-subtext">
              Completa tus datos y sube una foto para que la comunidad te reconozca.
            </p>
          </div>
        </div>

        <form id="perfilForm" class="grid perfil-form">
          <input name="nombre" id="perfilNombre" placeholder="Nombre y Apellido" required />
          <input name="email" id="perfilEmail" type="email" placeholder="Tu correo" />
          <select name="rol" id="perfilRol" required>
            <option value="miembro">Miembro</option>
            <option value="voluntario">Voluntario digital</option>
            <option value="moderador">Moderador (solicitud)</option>
          </select>
          <textarea name="bio" id="perfilBio" rows="3" placeholder="CuÃ©ntanos algo sobre ti (dones, servicios, hobbies)"></textarea>
          <button class="btn" type="submit">Guardar perfil</button>
        </form>

        <p class="perfil-hint">
          Tu rol de moderador serÃ¡ activado por un responsable. Mientras tanto podrÃ¡s participar como miembro o voluntario digital.
        </p>
      </section>
    </section>

    <!-- RECURSOS -->
    <section class="view" id="view-recursos" data-view="recursos" tabindex="-1">
      <section class="card" id="recursos">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ“‚">Recursos</h2>
          <label class="btn small adminOnly" hidden>
            Subir archivo
            <input id="fileRec" type="file" hidden />
          </label>
        </header>
        <ul id="listaRecursos" class="file-list"></ul>
      </section>
    </section>

    <!-- AVISOS -->
    <section class="view" id="view-avisos" data-view="avisos" tabindex="-1">
      <section class="card">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ””">Avisos</h2>
          <button id="btnPermPush" class="btn small">Activar notificaciones</button>
        </header>
        <ul id="avisosList" class="notice-list"></ul>
      </section>
    </section>
  </main>

  <!-- Tabs inferior -->
  <nav class="tabs" role="tablist" aria-label="Secciones principales">
    <button class="tab active" data-tab="inicio" role="tab" aria-selected="true">ğŸ <span>Inicio</span></button>
    <button class="tab" data-tab="eventos" role="tab" aria-selected="false">ğŸ“…<span>Eventos</span></button>
    <button class="tab" data-tab="comunidad" role="tab" aria-selected="false">ğŸ‘¥<span>Comunidad</span></button>
    <button class="tab" data-tab="recursos" role="tab" aria-selected="false">ğŸ“‚<span>Recursos</span></button>
    <button class="tab" data-tab="avisos" role="tab" aria-selected="false">ğŸ””<span>Avisos</span></button>
  </nav>

  <!-- FAB -->
  <button id="fab" class="fab" title="AcciÃ³n rÃ¡pida">ï¼‹</button>

  <!-- BotÃ³n para instalar la app -->
  <button id="btnInstallApp" class="btn-install" type="button" style="display:none;">
    ğŸ“² Instalar app
  </button>

  <!-- Panel lateral: Herramienta de Angie -->
  <aside id="angie-panel" class="sidepanel" aria-label="Herramienta de colores Angie">
    <div class="sidepanel-header">
      <h2>Paleta de colores (Angie)</h2>
      <button id="closeAngiePanel" class="icon-btn" type="button" aria-label="Cerrar Angie">âœ•</button>
    </div>
    <iframe
      src="Angie herramienta.html"
      class="sidepanel-iframe"
      title="Angie - herramienta de paleta">
    </iframe>
  </aside>

  <!-- App principal -->
  <script src="app.js"></script>

  <!-- Control Angie + tema + tokens + Supabase -->
  <script>
    (function () {
      const panel = document.getElementById('angie-panel');
      const btn = document.getElementById('btnAngie');
      const closeBtn = document.getElementById('closeAngiePanel');
      const overlay = document.getElementById('overlay');
      const themePicker = document.getElementById('themePicker');

      function openPanel() {
        panel?.classList.add('open');
        overlay?.classList.add('show');
      }
      function closePanel() {
        panel?.classList.remove('open');
        overlay?.classList.remove('show');
      }

      btn?.addEventListener('click', openPanel);
      closeBtn?.addEventListener('click', closePanel);
      overlay?.addEventListener('click', (e) => {
        if (panel?.classList.contains('open')) {
          e.stopPropagation();
          closePanel();
        }
      });

      // Atajo: Ctrl+Alt+A abre/cierra Angie
      window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'a') {
          if (panel?.classList.contains('open')) closePanel();
          else openPanel();
        }
        if (e.key === 'Escape' && panel?.classList.contains('open')) {
          closePanel();
        }
      });

      // Abrir Angie con ?angie=1
      const params = new URLSearchParams(window.location.search);
      if (params.has('angie')) {
        openPanel();
      }

      // ========= APLICAR TOKENS =========
      function applyTokens(tokens) {
        if (!tokens || typeof tokens !== 'object') return;
        const root = document.documentElement;

        if (tokens.brand) {
          root.style.setProperty('--brand', tokens.brand);
          root.style.setProperty('--guy-main', tokens.brand);
        }
        if (tokens.brand2) {
          root.style.setProperty('--brand-2', tokens.brand2);
        }
        if (tokens.accent) {
          root.style.setProperty('--accent', tokens.accent);
          root.style.setProperty('--girl-main', tokens.accent);
        }
        if (tokens.neutral900) root.style.setProperty('--neutral-900', tokens.neutral900);
        if (tokens.neutral700) root.style.setProperty('--neutral-700', tokens.neutral700);
        if (tokens.neutral400) root.style.setProperty('--neutral-400', tokens.neutral400);
        if (tokens.neutral100) root.style.setProperty('--neutral-100', tokens.neutral100);
      }

      // Hacer accesible para otros scripts (app.js si lo necesitas)
      window.jcApplyTokens = applyTokens;

      // ========= AUTO-RESTABLECER PALETA GUARDADA =========
      (function restoreTokensOnLoad() {
        const saved = localStorage.getItem('jc_tokens');
        if (!saved) return;
        try {
          const tokens = JSON.parse(saved);
          applyTokens(tokens);
          console.log('ğŸ’¾ Paleta personalizada restaurada desde localStorage.');
        } catch (e) {
          console.error('Error cargando jc_tokens:', e);
        }
      })();

      // ========= SELECTOR DE TEMA (chicos/chicas/mix/auto) =========
      function applyThemeMode(mode) {
        const root = document.documentElement;
        if (mode === 'chicos') {
          root.style.setProperty('--brand', '#2563eb');
          root.style.setProperty('--brand-2', '#1d4ed8');
          root.style.setProperty('--accent', '#60a5fa');
          root.style.setProperty('--guy-main', '#2563eb');
          root.style.setProperty('--girl-main', '#60a5fa');
          localStorage.setItem('jc_theme_mode', 'chicos');
        } else if (mode === 'chicas') {
          root.style.setProperty('--brand', '#ec4899');
          root.style.setProperty('--brand-2', '#db2777');
          root.style.setProperty('--accent', '#f97316');
          root.style.setProperty('--guy-main', '#ec4899');
          root.style.setProperty('--girl-main', '#f97316');
          localStorage.setItem('jc_theme_mode', 'chicas');
        } else if (mode === 'mix') {
          root.style.setProperty('--brand', '#2563eb');
          root.style.setProperty('--brand-2', '#1d4ed8');
          root.style.setProperty('--accent', '#ec4899');
          root.style.setProperty('--guy-main', '#2563eb');
          root.style.setProperty('--girl-main', '#ec4899');
          localStorage.setItem('jc_theme_mode', 'mix');
        } else {
          // auto = respetar lo que estÃ© en tokens
          localStorage.setItem('jc_theme_mode', 'auto');
        }
      }

      const savedMode = localStorage.getItem('jc_theme_mode') || 'auto';
      if (themePicker) {
        themePicker.value = savedMode;
        if (savedMode !== 'auto') applyThemeMode(savedMode);
        themePicker.addEventListener('change', (e) => {
          applyThemeMode(e.target.value);
        });
      } else {
        if (savedMode !== 'auto') applyThemeMode(savedMode);
      }

      // ========= ESCUCHAR A ANGIE Y GUARDAR EN SUPABASE =========
      window.addEventListener('message', async (event) => {
        const data = event.data;
        if (!data || data.type !== 'jc-apply-tokens') return;

        try {
          const tokens = data.tokens;
          if (!tokens || typeof tokens !== 'object') return;

          // Guardar en localStorage
          localStorage.setItem('jc_tokens', JSON.stringify(tokens));

          // Aplicar directamente
          applyTokens(tokens);

          // Guardar en Supabase por usuario (si hay sesiÃ³n)
          const sb = window.supabaseClient;
          if (sb && sb.auth) {
            try {
              const { data: userRes, error: authErr } = await sb.auth.getUser();
              if (!authErr && userRes?.user?.id) {
                const uid = userRes.user.id;
                const modo = localStorage.getItem('jc_theme_mode') || 'personalizado';

                await sb
                  .from('paletas_usuarios') // crea esta tabla en Supabase
                  .upsert(
                    {
                      user_id: uid,
                      tokens,
                      modo,
                      updated_at: new Date().toISOString()
                    },
                    { onConflict: 'user_id' }
                  );
              }
            } catch (e) {
              console.error('Error guardando paleta en Supabase:', e);
            }
          }

          alert('Paleta aplicada a Juventud CNC. Los cambios deberÃ­an verse de inmediato.');

        } catch (e) {
          console.error('Error aplicando tokens de Angie:', e);
        }
      });
    })();
  </script>

  <script>
    // Mostrar botÃ³n de "Instalar app" cuando el navegador lo permita
    let deferredPrompt = null;
    const installBtn = document.getElementById('btnInstallApp');

    window.addEventListener('beforeinstallprompt', (e) => {
      // Evita que salga el banner automÃ¡tico
      e.preventDefault();
      deferredPrompt = e;
      if (installBtn) {
        installBtn.style.display = 'inline-flex';
      }
    });

    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('Resultado instalaciÃ³n:', outcome);
        deferredPrompt = null;
        installBtn.style.display = 'none';
      });
    }

    window.addEventListener('appinstalled', () => {
      console.log('âœ… App Juventud CNC instalada');
      if (installBtn) installBtn.style.display = 'none';
    });
  </script>
</body>
</html>