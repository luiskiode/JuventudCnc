<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Juventud CNC</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <meta name="theme-color" content="#0b1020" />

  <!-- SDKs base -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-messaging-compat.js"></script>

  <!-- ConfiguraciÃ³n de Supabase y Firebase
       (IMPORTANTE: asegurarse que estos archivos definan:
        - window.supabaseClient = supabase.createClient(...)
        - firebase.initializeApp(...)
       ) -->
  <script src="supabase-config.js" defer></script>
  <script src="firebase-config.js" defer></script>

  <!-- Modo diseÃ±o (lee jc_tokens) -->
  <script src="design-mode.js" defer></script>

  <!-- Panel tÃ©cnico / diagnÃ³stico -->
  <script src="debug-dashboard.js" defer></script>
</head>

<body class="app-shell">
  <!-- Drawer lateral -->
  <aside id="drawer" class="drawer" aria-label="MenÃº principal">
    <div class="drawer-header">
      <h2>Juventud CNC</h2>
      <button id="closeDrawer" class="icon-btn" aria-label="Cerrar menÃº">âœ•</button>
    </div>
    <nav class="drawer-nav">
      <a href="#inicio" data-tab="inicio">Inicio</a>
      <a href="#eventos" data-tab="eventos">Eventos</a>
      <a href="#comunidad" data-tab="comunidad">Comunidad</a>
      <a href="#recursos" data-tab="recursos">Recursos</a>
      <a href="#avisos" data-tab="avisos">Avisos</a>
    </nav>
    <footer class="drawer-footer">
      v1.0 â€¢ Pensado para jÃ³venes ğŸ’™ğŸ’—
    </footer>
  </aside>

  <!-- Overlay compartido (drawer + Angie) -->
  <div id="overlay" class="overlay" tabindex="-1" aria-hidden="true"></div>

  <!-- Topbar -->
  <header class="topbar">
    <button id="openDrawer" class="icon-btn" aria-label="Abrir menÃº">â˜°</button>
    <h1 class="topbar-title">Juventud CNC</h1>
    <div class="topbar-actions">
      <button id="btnAngie" class="icon-btn" aria-label="Herramienta de colores">ğŸ¨</button>
      <button id="btnPerfil" class="icon-btn" aria-label="Perfil">ğŸ‘¤</button>
    </div>
  </header>

  <!-- Vistas -->
  <main class="container" id="main">
    <!-- INICIO -->
    <section class="view active" id="view-inicio" data-view="inicio" tabindex="-1">
      <!-- Mensaje semanal -->
      <section class="card" id="mensaje-semanal">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ•Šï¸">Mensaje semanal</h2>
          <span class="badge badge-mix">Para chicos ğŸ’™ y chicas ğŸ’—</span>
        </header>
        <article class="card-body">
          <h3 id="msgTitle">Cargando mensaje...</h3>
          <p id="msgBody">
            AquÃ­ aparecerÃ¡ una palabra breve para acompaÃ±ar tu semana:
            estudio, trabajo, servicio y descanso.
          </p>
          <small id="msgMeta">â€“</small>
        </article>
      </section>

      <!-- Hero bienvenida -->
      <section class="card hero">
        <div class="hero-content">
          <h2>Bienvenido a Juventud CNC</h2>
          <p>Un solo espacio para que jÃ³venes hombres y mujeres crezcan, sirvan y se encuentren con Dios.</p>
          <div class="hero-badges" aria-hidden="true">
            <span class="badge badge-guy">Chicos ğŸ’™</span>
            <span class="badge badge-girl">Chicas ğŸ’—</span>
          </div>
        </div>
        <div class="hero-icons" aria-hidden="true">
          âœï¸
          <span class="hero-gradient-bubbles"></span>
        </div>
      </section>

      <!-- PrÃ³ximos eventos (vista rÃ¡pida) -->
      <section class="card">
        <div class="card-header">
          <h3 class="with-emoji" data-emoji="ğŸ“…">PrÃ³ximos eventos</h3>
          <a class="link" href="#eventos" data-tab="eventos">Ver todos</a>
        </div>
        <ul id="eventListHome" class="event-list"></ul>
        <p class="muted small">
          AquÃ­ verÃ¡s los prÃ³ximos 4 eventos. Para ver el calendario completo entra en la pestaÃ±a
          <strong>Eventos</strong>.
        </p>
      </section>
    </section>

    <!-- EVENTOS -->
    <section class="view" id="view-eventos" data-view="eventos" tabindex="-1">
      <section class="card">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ“…">Eventos</h2>
          <div class="filter-group">
            <label for="filtroTipo" class="muted small">Filtrar</label>
            <select id="filtroTipo">
              <option value="">Todos</option>
              <option value="reuniÃ³n">ReuniÃ³n</option>
              <option value="formaciÃ³n">FormaciÃ³n</option>
              <option value="retiro">Retiro</option>
              <option value="vigilia">Vigilia</option>
              <option value="voluntariado">Voluntariado</option>
            </select>
          </div>
        </header>
        <ul id="eventList" class="event-list"></ul>
      </section>
    </section>

    <!-- COMUNIDAD -->
    <section class="view" id="view-comunidad" data-view="comunidad" tabindex="-1">
      <!-- Registro -->
      <section class="card" id="miembros">
        <h2 class="with-emoji" data-emoji="ğŸ‘¥">Registro de miembros</h2>
        <form id="formMiembro" class="grid">
          <input name="nombre" placeholder="Nombre y apellido" required />
          <input name="edad" type="number" placeholder="Edad" min="10" max="99" required />
          <input name="contacto" type="tel" placeholder="Contacto (celular)" />
          <input name="ministerio" placeholder="Ministerio / grupo (opcional)" />
          <select name="rol_key">
            <option value="miembro">Miembro</option>
            <option value="moderador">Moderador</option>
          </select>
          <button class="btn" type="submit">Guardar</button>
        </form>
      </section>

      <!-- Comunidad activa (chips) -->
      <section class="card">
        <h3 class="with-emoji" data-emoji="â­">Comunidad activa</h3>
        <div class="grid grid-compact">
          <button class="chip chip-guy" data-action="retos">ğŸ’ª Retos para chicos</button>
          <button class="chip chip-girl" data-action="retos-chicas">âœ¨ Retos para chicas</button>
          <button class="chip" data-action="noticias">ğŸ“° Noticias parroquiales</button>
          <button class="chip" data-action="multimedia">ğŸ¶ Multimedia</button>
          <button class="chip" data-action="foro">ğŸ’¬ Foro joven</button>
        </div>
        <p class="muted small">(Estas secciones se irÃ¡n habilitando por fases.)</p>
      </section>
    </section>

    <!-- RECURSOS -->
    <section class="view" id="view-recursos" data-view="recursos" tabindex="-1">
      <section class="card" id="recursos">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ“‚">Recursos</h2>
          <label class="btn small adminOnly" hidden>
            Subir archivo
            <input id="fileRec" type="file" hidden />
          </label>
        </header>
        <ul id="listaRecursos" class="file-list"></ul>
      </section>
    </section>

    <!-- AVISOS -->
    <section class="view" id="view-avisos" data-view="avisos" tabindex="-1">
      <section class="card">
        <header class="card-header">
          <h2 class="with-emoji" data-emoji="ğŸ””">Avisos</h2>
          <button id="btnPermPush" class="btn small">Activar notificaciones</button>
        </header>
        <ul id="avisosList" class="notice-list"></ul>
      </section>
    </section>
  </main>

  <!-- Tabs inferior -->
  <nav class="tabs" role="tablist" aria-label="Secciones principales">
    <button class="tab active" data-tab="inicio" role="tab" aria-selected="true">ğŸ <span>Inicio</span></button>
    <button class="tab" data-tab="eventos" role="tab" aria-selected="false">ğŸ“…<span>Eventos</span></button>
    <button class="tab" data-tab="comunidad" role="tab" aria-selected="false">ğŸ‘¥<span>Comunidad</span></button>
    <button class="tab" data-tab="recursos" role="tab" aria-selected="false">ğŸ“‚<span>Recursos</span></button>
    <button class="tab" data-tab="avisos" role="tab" aria-selected="false">ğŸ””<span>Avisos</span></button>
  </nav>

  <!-- FAB -->
  <button id="fab" class="fab" title="AcciÃ³n rÃ¡pida">ï¼‹</button>

  <!-- Panel lateral: Herramienta de Angie -->
  <aside id="angie-panel" class="sidepanel" aria-label="Herramienta de colores Angie">
    <div class="sidepanel-header">
      <h2>Paleta de colores (Angie)</h2>
      <button id="closeAngiePanel" class="icon-btn" type="button" aria-label="Cerrar Angie">âœ•</button>
    </div>
    <iframe
      src="Angie herramienta.html"
      class="sidepanel-iframe"
      title="Angie - herramienta de paleta">
    </iframe>
  </aside>

  <!-- App principal -->
  <script src="app.js"></script>

  <!-- Control del panel de Angie + integraciÃ³n de tokens -->
   <script>
    (function () {
      const panel = document.getElementById('angie-panel');
      const btn = document.getElementById('btnAngie');
      const closeBtn = document.getElementById('closeAngiePanel');
      const overlay = document.getElementById('overlay');

      if (!panel) return;

      function openPanel() {
        panel.classList.add('open');
        if (overlay) overlay.classList.add('show');
      }

      function closePanel() {
        panel.classList.remove('open');
        if (overlay) overlay.classList.remove('show');
      }

      if (btn) btn.addEventListener('click', openPanel);
      if (closeBtn) closeBtn.addEventListener('click', closePanel);
      if (overlay) overlay.addEventListener('click', (e) => {
        if (panel.classList.contains('open')) {
          e.stopPropagation();
          closePanel();
        }
      });

      // Atajo: Ctrl+Alt+A para abrir/cerrar Angie
      window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'a') {
          if (panel.classList.contains('open')) {
            closePanel();
          } else {
            openPanel();
          }
        }
        if (e.key === 'Escape') {
          if (panel.classList.contains('open')) {
            closePanel();
          }
        }
      });

      // Activar automÃ¡ticamente si la URL trae ?angie=1
      const params = new URLSearchParams(window.location.search);
      if (params.has('angie')) {
        openPanel();
      }

      // ğŸ”— IntegraciÃ³n: escuchar mensajes de Angie con tokens de diseÃ±o
      window.addEventListener('message', (event) => {
        const data = event.data;
        if (!data || data.type !== 'jc-apply-tokens') return;

        try {
          const tokens = data.tokens;
          if (!tokens || typeof tokens !== 'object') return;

          // Guardar tokens en localStorage para design-mode.js
          localStorage.setItem('jc_tokens', JSON.stringify(tokens));

          const root = document.documentElement;

          // brand â†’ var(--brand) y tambiÃ©n --guy-main
          if (tokens.brand) {
            root.style.setProperty('--brand', tokens.brand);
            root.style.setProperty('--guy-main', tokens.brand);
          }

          // brand2 â†’ var(--brand-2)
          if (tokens.brand2) {
            root.style.setProperty('--brand-2', tokens.brand2);
          }

          // accent â†’ var(--accent) y tambiÃ©n --girl-main
          if (tokens.accent) {
            root.style.setProperty('--accent', tokens.accent);
            root.style.setProperty('--girl-main', tokens.accent);
          }

          // Neutrales
          if (tokens.neutral900) root.style.setProperty('--neutral-900', tokens.neutral900);
          if (tokens.neutral700) root.style.setProperty('--neutral-700', tokens.neutral700);
          if (tokens.neutral400) root.style.setProperty('--neutral-400', tokens.neutral400);
          if (tokens.neutral100) root.style.setProperty('--neutral-100', tokens.neutral100);

          alert('Paleta aplicada a Juventud CNC. Los colores principales ya deberÃ­an cambiar.');

        } catch (e) {
          console.error('Error aplicando tokens de Angie:', e);
        }
      });
    })();
  </script>

  <script>
  // AUTO-RESTABLECER PALETA GUARDADA
  (function () {
    const saved = localStorage.getItem('jc_tokens');
    if (!saved) return;

    try {
      const tokens = JSON.parse(saved);
      const root = document.documentElement;

      if (tokens.brand) {
        root.style.setProperty('--brand', tokens.brand);
        root.style.setProperty('--guy-main', tokens.brand);
      }
      if (tokens.brand2) {
        root.style.setProperty('--brand-2', tokens.brand2);
      }
      if (tokens.accent) {
        root.style.setProperty('--accent', tokens.accent);
        root.style.setProperty('--girl-main', tokens.accent);
      }

      if (tokens.neutral900) root.style.setProperty('--neutral-900', tokens.neutral900);
      if (tokens.neutral700) root.style.setProperty('--neutral-700', tokens.neutral700);
      if (tokens.neutral400) root.style.setProperty('--neutral-400', tokens.neutral400);
      if (tokens.neutral100) root.style.setProperty('--neutral-100', tokens.neutral100);

      console.log("ğŸ’¾ Paleta personalizada restaurada automÃ¡ticamente.");
    } catch (e) {
      console.error("Error cargando tokens guardados:", e);
    }
  })();
</script>
</body>
</html>